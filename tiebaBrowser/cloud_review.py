# -*- coding:utf-8 -*-
__all__ = ('CloudReview',)


import re
from typing import Optional, Union
from urllib.parse import unquote

import imagehash
import pyzbar.pyzbar as pyzbar

from .api import Browser
from .data_structure import BasicUserInfo
from .logger import log
from .mysql import MySQL


class RegularExp(object):

    contact_exp = re.compile(
        '(\+|åŠ |è”ç³»|ç§|æ‰¾).{0,2}æˆ‘|(d|æ»´)æˆ‘|(ç§|s)(ä¿¡|æˆ‘|èŠ)|æ»´æ»´|di?di?', re.I)
    contact_rare_exp = re.compile('(åœ¨|çœ‹|â†’|ğŸ‘‰|â˜æ”¾).{0,3}(æˆ‘|ä¿º|å¶).{0,3}((è´´|å¸–)(å­|é‡Œ)|å…³æ³¨|ä¸»é¡µ|ä¸»ä¸š|èµ„æ–™|ç­¾å|å°¾å·´|ç®€ä»‹|(å¤´|æŠ•)(åƒ|è±¡))|(å¤´|æŠ•).(åƒ|è±¡)|ä¸».é¡µ|(å…³æ³¨|ä¸»é¡µ|ä¸»ä¸š|èµ„æ–™|ç­¾å|å°¾å·´|ç®€ä»‹|(å¤´|æŠ•)(åƒ|è±¡))(æœ‰|å®‰æ’|ä¸Šè½¦)|å¨(ä¿¡|è¾›)|vä¿¡|(\+|åŠ |è”ç³»|äº†è§£|å|ï¼‹|ç§|æ‰¾|ä¼½).{0,2}(å¾®ä¿¡|å¨|è–‡|å¾½|å¾®|wx|v|q|ä¼é¹…|æ‰£æ‰£|â¤|è”»|å¯‡|å¶)|(å|ï¼‹|ä¼½).{0,2}(æˆ‘|ä¿º|å¶)|(å¨|è–‡|å¨|å¾®|wx|v|ä¼é¹…|æ‰£æ‰£|â¤|è”»|å¯‡).{0,2}(:|ï¼š|å·|æ¥¼ä¸‹|ç­¾å)|q.?\d{6,11}|æœ‰æ„.{0,3}(s|ç§)|è¿ç»†æ–¹å¼|ç½”å€|èŠ·|ä¸ª.?æ€§.?ç­¾.?å|ç°½|èœ|è²¼|âˆ¨|â“‹|âœ™|â•|å¾¾', re.I)

    course_exp = re.compile(
        'æ‘„å½±|è§†é¢‘(å‰ªè¾‘|ç‰¹æ•ˆ)|(ç»˜|ç”»|å›½)ç”»|åæœŸ|CAD|ç´ æ|å½©é“…|æ¿ç»˜|è®¾è®¡|ps|ç¾æœ¯|æ°´å½©|é¢†å–.{0,3}è¯¾ç¨‹|è‹±è¯­å£è¯­|æ¼”å”±|å£°ä¹|å”±.{0,3}æŠ€å·§|å­¦å†|å¤‡æ³¨è´´å§', re.I)
    course_check_exp = re.compile(
        'äº¤æµç¾¤|è¯¾ç¨‹|å¾’å¼Ÿ|ç´ æ|èµ„æ–™|æ•™(ç¨‹|å­¦)|å­¦ä¹ |é‚®ç®±|ç•™è¨€|æ‰£.?1|(æƒ³|è¦)å­¦|æå‡|å°ä¼™ä¼´')

    app_nocheck_exp = re.compile(
        'taoå¯³|tbå£ä»¤|(æ·˜å®|æŠ–éŸ³).{0,2}(å·|hao)|ç»¿è‰².{0,2}å¹³å°|èµ›äº‹é¢„æµ‹|ã€æ”¯ä»˜å®ã€‘|è§£å°å¾®ä¿¡|æ‰«ç .{0,3}é€çº¢åŒ…|å…³æ³¨.{0,2}å¾®åš|è¯­éŸ³ç¤¾äº¤|å¸®æ³¨å†Œ|èŒ¨|è§†é¢‘åŠ©æ‰‹|å‘…|å¬´|ç€›|è¤‡åˆ¶|æ”¶soul.?å¤©|â†“ä½|æµäº®|èŠå¤©.?æœ‰æƒŠå–œ|ã€å¨›ã€‘|ç¼…ç”¸.{0,3}å¨±ä¹|ç§Ÿæˆ¿ç¥å™¨|æµ®åŠ›è½¦è½¦|é¢å›¢|å£ä»¤æ‰“å¼€æ·˜å®', re.I)
    app_exp = re.compile(
        'æ‹¼(å¤•å¤•|å¤šå¤š|dd)|äº¬(ä¸œ|d)|æŠ–éŸ³|æ”¯ä»˜å®|æ·˜.?å®|ç«å±±å°è§†é¢‘|å¾®ä¿¡|é¥¿.?äº†.?ä¹ˆ|ç¾.?å›¢|å”¯å“ä¼š|è‹å®|å¿«æ‰‹|æ˜“è´­|app.{0,4}ä¸‹è½½|åŒ(11|åä¸€)|è¯­éŸ³å¹³å°|èµ·ç‚¹è¯»ä¹¦|éœ€è¦.{0,2}app', re.I)
    app_check_exp = re.compile(
        'ç‚¹ä¸€ä¸‹|ç‚¹èµ|ä»»åŠ¡|å¤åˆ¶|è´¦å·|ç»¿è‰²|å¼€åº—|åº—é“º|è¿è¥|æœ|çº¢.?åŒ…|ç¦åˆ©|æ¨å¹¿|è˜|å…è´¹|(å¹¿å‘Š|ç²¾å‡†)æŠ•æ”¾|æ´»åŠ¨|åŠ©åŠ›|ç‰¹ä»·|é‚€è¯·ç |ä½£.?é‡‘|å˜ç°')

    business_exp = re.compile(
        '[^\d]1[345789]\d{9}[^\d]|(é«˜ä»¿|å¤åˆ»|è´­).{0,3}(é‹|åŒ…|è¡¨)|é‹æ–‡åŒ–|æ½®.{0,2}é‹|å‘º|æ ¸é›•|è†ç”°|å·¥å‚ç›´ä¾›|å“è´¨ä¿è¯|å…è´¹é‰´å®š|ä»·æ ¼ç¾ä¸½|æ½®ç‰Œå¤åˆ»|å¥¢æ½®|æœ¬åº—ä¸»è¥|(å®æƒ |ç¾Šæ¯›).*ç¾¤|æ’¸è´§|çº¿æŠ¥|å‚å®¶è´§æº|åŠ©åŠ›å¾®å•†|#åæœŸ#.*åšç†Ÿæ‚‰|ç»¿è‰²æ­£è§„è¡Œä¸š|ä»·æ ¼å¯è°ˆ|é‡‘é’±è‡ªç”±|é›¶å”®å•†|ç½‘èµŒ|ç«çˆ†æ‹›å•†|å¯¹æ¥å·¥å‚|å®æ‹åŒºåˆ«|è‡»æƒ…|é’œçŒ®|ç«çƒ­é¢„çº¦|ç”µå­å•†åŠ¡|æœ‰é™å…¬å¸|å…¬å¸.{0,2}æ³¨å†Œ|è“·|å»£|æ•™è‚²å“ç‰Œ|å¼•æµæ‹›å•†|è‡ªä¸»ç ”å‘|å…¨å›½å®¢æœç”µè¯|å›é¦ˆå®¢æˆ·|å¯æ¥å®šåˆ¶|åŸ¹è®­è¾…å¯¼|(æŠ•æ”¾).{0,2}å¹¿|é«˜(è½¬åŒ–|æ”¶ç›Š)|å€Ÿè´·|æœ‹å‹æ¨è.*äº§å“|åŒºå—é“¾|è¿›è£™|ç¦åˆ©.*è¿›ç¾¤|åå¼ºåŒ—|AirPods|ç»å°¿é…¸', re.I)

    job_nocheck_exp = re.compile(
        'æˆç«‹å·¥ä½œå®¤|æƒ³åšå•|å®å¦ˆ[^å¦ˆ]|(è·Ÿç€|åŠ¨æ‰‹æŒ‡).{0,2}èµšé’±|å…è´¹å…¥èŒ|(æ‹›|æ”¶).{0,4}(ä¸´æ—¶å·¥|å¾’|ä»£ç†)|(åœ¨å®¶|è½»æ¾).{0,2}(å¯|èƒ½|æ²¡äº‹).?åš|æ—¶é—´è‡ªç”±|ç…ç›´|å…¼è€³åª|å‹‰è´¹|ä¸Šè¿.*æ²¡é—®é¢˜|ä¸æ”¶.?ä»»ä½•è´¹ç”¨|åŒ…é£Ÿå®¿|vxè¾…åŠ©|é—²æ—¶æ— èŠ|åšæŒ.*æ—¥å…¥è¿‡|èµšç±³|è¯­éŸ³èŠå¤©|ä¸€å¯¹ä¸€ç›´æ’­|æœ‰æƒ³.*çš„(æœ‹å‹|å…„å¼Ÿ)|åŒ…å­¦ä¼š|åŒ…åˆ†é…|å·¥ä½œ(è½»æ¾|ç®€å•)|ä¸æ”¶(ç±³|é’±)|åé¢æœ‰é™|åœ¨å®¶.{0,4}æ“ä½œ|è½¬å‘æœ‹å‹åœˆ|æ‰‹å·¥æ´»|å·å•†|(åˆ·|åš)(å•|é”€é‡)', re.I)
    job_exp = re.compile(
        'ä½£é‡‘|æŠ¼é‡‘|ä¼šè´¹|åŸ¹è®­|ç»“ç®—|(æ—¥|ç«‹)(ç»“|æ´)|é«˜ä½£|é¤è¡¥|æƒ³åšçš„|æœ‰å…´è¶£|(æ€¥|é•¿æœŸ|å¤§é‡)æ‹›|æ‹›(å‹Ÿ|è˜)|ç¨³èµš|(ä¸€|æ¯)(å¤©|æ—¥|æœˆ)\d{2,3}|(æ—¥|æœˆ)(å…¥|è¿›).{0,2}(å…ƒ|å—|ç™¾|ä½°|ä¸‡|åƒ|w)|(åˆ©æ¶¦|æ”¶ç›Š|å·¥èµ„|è–ªèµ„|æ”¶å…¥|ç¦åˆ©|å¾…é‡)(é«˜|å¥½|\d{3,})|(é«˜|å¥½)(åˆ©æ¶¦|æ”¶ç›Š|å·¥èµ„|è–ªèµ„|æ”¶å…¥|ç¦åˆ©|å¾…é‡)|ä½(é£é™©|æŠ•å…¥)|é£é™©ä½|æ­£è§„åˆæ³•|åˆä½œæ„‰å¿«|æ‰‹æœº.*å°±(è¡Œ|å¯)|(æœ‰|ä¸€).?æ‰‹æœº|æ‰¶æŒ|é•¿æœŸå•', re.I)
    job_check_exp = re.compile(
        '(æš‘å‡|ä¸´æ—¶|çŸ­æœŸ)å·¥|åˆä¼™|å…¼èŒ|ä¸»æ’­|å£°æ’­|ç­¾çº¦|è‰ºäºº|æ¨¡ç‰¹|é™ªç©|è¯•éŸ³|æ’­éŸ³|å†™æ‰‹|ç‚¹èµå‘˜|æ¥å•|å·¥ä½œå®¤|å·¥å‚|æ‰‹å·¥|é¡¹ç›®|ç”µå•†|æ¸¸æ³³å¥èº«|æœ‰å£°(è¯»ç‰©|ä¹¦)|åˆ›ä¸š|è‡ªåª’ä½“|åŠ ç›Ÿ|å‰¯ä¸š|ä»£ç†|(å…è´¹|éœ€è¦|è¯šä¿¡|è¯šå¿ƒ)(å¸¦|åš)|æƒ³(èµš|æŒ£)é’±|ä¸ç”˜.?ç°çŠ¶|å¾®å•†|å¾®ä¿¡|æŠ•èµ„|å†™å¥½è¯„|ä¸å«Œå°‘|éœ€å·¥ä½œ|å½¢è±¡å¥½|æ°”è´¨ä½³|èµ¢.{0,2}å¥–é‡‘')

    game_nocheck_exp = re.compile(
        '(æ‹›|æ‰¾).{0,4}(æ‰˜|æ‹–|å†…éƒ¨|äººå‘˜|ä½“éªŒå‘˜)|(ç‹—|æ‰‹æ¸¸|æ¸¸æˆ|å†…éƒ¨).?(æ‰˜|æ‹–|è„±|èµ„æ ¼|å·)|(æ‰˜|æ‹–|è„±)(è£™|ç¾¤)|è¿›æ¸¸(æœ‰|ç»™)|ä¸Šçº¿å°±é€|æ¥äººä½“éªŒ|åˆºæ¿€ç©å®¶æ¶ˆè´¹|(èµ°å¿ƒ|æ‰‹æ¸¸|æœ¬å§|æœ¬å¸–|æœ¬è´´).{0,2}æ¨è|ä½“éªŒæ°ªé‡‘å¤§ä½¬|ç­‰çº§ç›´æ¥è°ƒ|(çœŸå®|æœ‰æ•ˆ)(å†²|å……)å€¼|(ç­‰çº§|çº¿ä¸‹)æ‰¶æŒ|èŒ—é¢|æ¸¸æ¨è|ç‰¹æƒç¤¼åŒ…|æ–°åŒº.{0,2}å¼€|éœ¸æœ|å–œæ¬¢ç©.*ä»™ä¾ |(æ—¥|å¤©|é€|é¢†|ç»™ä½ |å…è´¹).{0,2}(648|å…ƒå®)|æ‰‹æ¸¸.{0,2}(æ‹›|çˆ±å¥½è€…)|å¤§.?ä¸.?åŒ.{1,4}ç½‘|å®˜ç½‘.{1,7}å˜æ€|æ‰‹æ¸¸å®˜ç½‘|Bï¼ˆç‰ˆï¼‰Tï¼ˆæœ¬ï¼‰|dbt.?apk|B-Tç‰ˆæœ¬|Ğ²|(å½“|åš)æ¸¸æˆä¸»æ’­|æ¥å°±.{0,2}é€|è£|éŠ|æˆ²|è™Ÿ|ä¾—|çš®è‚¤æœ€æ–°è·å–|é¹|å€|è¼‘|é¿å…ç©å®¶æµå¤±')
    game_exp = re.compile('æ‰‹æ¸¸|æ¸¸æˆ|ç©å®¶|ä»™ä¾ |å›½æˆ˜|æ–°åŒº')
    game_check_exp = re.compile(
        'ç¥è±ª|æ‰˜|æ¼”å‘˜|å……å€¼|è¯•ç©|å†…ç©|é™æ—¶|é€Ÿæ¥|ä½“éªŒ|å¼€æœ|å†…æµ‹|èµ„æº|ç¦åˆ©|æ¯å¤©éƒ½æœ‰|æ¨å¹¿|å…³æ³¨ä¸‹|å†…éƒ¨å·|æ‰¶æŒ|å˜´ä¸¥|è¿½æ€|ç‰¹æƒç¤¼åŒ…')

    name_nocheck_exp = re.compile(
        'é­¸|è†ç”°|^æ‹é­‚.{2,3}ğŸ”¥$|^è½°ç‚¸(è½¯ä»¶|æœº)|è€å¸æœºçœ‹ç‰‡|å¯¼èˆª|å¼•æµ|æ¨å¹¿|èµšé’±|æ‰‹æ¸¸|(æ|å˜)ç°|æ¨å¹¿|ç”µå•†|å¹³å°|ç­¾å|(å¤´|æŠ•)(åƒ|è±¡)|(ä¸»|ç…®)é¡µ|èµ„(æº|æ–™)|å¤§ä¸åŒå®˜ç½‘')
    name_exp = re.compile('ğŸ˜|â˜œ|â˜|ğŸ’Œ|ğŸ’‹')
    name_check_exp = re.compile('wx|\d{6,}|ä¼é¹…')

    maipian_exp = re.compile(
        '(ä¸‹|â†“).{0,3}æœ‰æƒŠå–œ|æµ®åŠ›è½¦|ç½‘çº¢.{0,3}ä½œå“|æˆäººçœ‹çš„|é‚£è¾¹é‚£è°20|å…è²»|å®….{0,5}åº¦å¨˜|[ğŸ™-ğŸ¡]|ä»“äº•ç©ºåœ¨ç­‰å°¼|å°æƒ…ä¾£|æ³¨æ„èº«ä½“|æ˜è‰³åŠ¨äººçš„å°å§å§|æ¨è.{0,3}èµ„æº|å›å¤.*:ä½ (å¸–|è´´).*å¯ä»¥çœ‹|è‡ªå·±ä¸Šå¾®.?è–„|è‡ªå·±.*æœ|éƒ½æœ‰.*çœ‹æˆ‘å…³æ³¨çš„äºº|èŒƒ åš|çœ‹åç¥å™¨|å­¦å§ç»™æˆ‘åƒ|æ¨èå‘å±•å¯¹è±¡|^éº¦ç‰‡$|å–æ·«|å«‚å­ç›´æ¥.*é‚£ä¸ª|å°å“¥å“¥ä»¬.*çœ‹æˆ‘|è¿›å».*å¼„å¾—å–·æ°´|(çœ‹|æœ‰)å¥³ç¥|å™œ.?ä¸ªæœˆ|è‚¾ä¸å¥½|ç®¹|ã€–.ã€—|è¯šäºº|28.ME|æ¹–åŒ—å•æ‰€|\.xyz')
    female_check_exp = re.compile(
        '9\då¹´|(ç›†|æœ‹|äº¤|å¤„).?å‹|æœ‰äººèŠ|èŠå¤©|è¡¨å§|è€å¨˜|å¥½å­¤å•|å•èº«|ç¡ä¸ç€|æ‹çˆ±|çˆ±ä¼šæ¶ˆå¤±|çˆ±æƒ…|å¯¹è±¡|å¥”ç°|ç½‘æ‹|äº²å¯†|çº¦ä¼š|(è¶…|ç”œ)ç”œ|å¹²ç‚¹å•¥|å¯¹æˆ‘åš|æ— èŠ|æ‰‹ç‰µæ‰‹|æˆ‘çš„b|è¢«ä½ éª‘|(ç´„|æ‚¦)ç‚®|å°gg|å‹¾æ­|(å¤§|å°)å¯çˆ±|æ†‹ç–¯äº†|è®¤è¯†ä¸€ä¸‹|æˆ‘.?æœ‰è¶£|å‘†åœ¨å®¶é‡Œ|å¸¦ä¸ªäººå›å®¶|ç›¸ä¸ª?äº²|è®¤çœŸå¤„|çœŸå¿ƒ|æ€§æ„Ÿ|å¸Œæœ›é‡åˆ°|å«ä¸å‡ºå»|å¤§å”|è¶Šæ¥è¶Šæ‡’|å¯æ‚¦|ç­¾æ”¶|æ‰‹çº¸|å†…è¡£|é™ªæˆ‘|å‘æ³„|èº«æ|å©š|æˆ‘éƒ½æœ‰|çš„æˆ‘')

    hospital_exp = re.compile('åŒ»é™¢.*å¥½ä¸å¥½|ç‹è‡­|ç—”ç–®|æ€§è…º|é˜³ç—¿|æ—©æ³„|ä¸å­•ä¸è‚²|å‰åˆ—è…º|å¦‡ç§‘|ä¼šæ‰€|æ‰‹ç›¸')

    lv1_exp = re.compile(
        'å…¬ä¼—å·|ä¼ åª’|æ–°åª’ä½“|å©šæ‹|è´¢ç»|é±¼èƒ¶|ä¿¡ï¸„ç”¨å¡|çœ‹æ‰‹ç›¸|å‡ºç§Ÿ|å¡”ç½—|ä»£éª‚|æ¶ˆç¾|é—®å·è°ƒæŸ¥|æœ‰æ„è€…|(é‚ª|æ‰‹)æ·«.{0,3}å±å®³|æ€¥éœ€.{0,10}é’±|(å…è´¹|èµ„æº)åˆ†äº«|æ‡‚(çš„|å¾—)æ¥|ä»£ç»ƒ|æˆ‘å‘è¡¨äº†ä¸€ç¯‡å›¾ç‰‡')

    kill_thread_exp = re.compile('åœ°ç¥‰|ç‰¹ä»·ç‰ˆ', re.I)


class CloudReview(Browser):
    """
    äº‘å®¡æŸ¥åŸºç±»
    CloudReview(BDUSS_key,tieba_name,sleep_time=0)

    å‚æ•°:
        BDUSS_key: str ç”¨äºè·å–BDUSS
        tieba_name: str è´´å§å
        sleep_time: float æ¯ä¸¤æ¬¡äº‘å®¡æŸ¥çš„é—´éš”æ—¶é—´
    """

    __slots__ = ['tieba_name',
                 'sleep_time',
                 'exp',
                 'mysql']

    def __init__(self, BDUSS_key: Optional[str], tieba_name: str, sleep_time: float = 0):
        super().__init__(BDUSS_key)

        self.tieba_name = tieba_name
        self.sleep_time = sleep_time

        self.mysql = MySQL()

        self.exp = RegularExp()

    def close(self) -> None:
        self.mysql.close()
        super().close()

    def update_user_id(self, id: Union[str, int], mode: bool = True) -> bool:
        """
        å‘åå•ä¸­æ’å…¥user_id
        update_user_id(id,mode=True)
        """

        if type(mode) != bool:
            log.warning("Wrong mode in update_user_id!")
            return False

        user = BasicUserInfo(id)
        user = self.get_userinfo_weak(user)
        if not user.user_id:
            return False

        return self.mysql.update_user_id(self.tieba_name, user.user_id, mode)

    def del_user_id(self, id: Union[str, int]):
        """
        ä»åå•ä¸­åˆ é™¤user_id
        del_user_id(id)
        """

        user = BasicUserInfo(id)
        user = self.get_userinfo_weak(user)
        if not user.user_id:
            return False

        return self.mysql.del_user_id(self.tieba_name, user.user_id)

    def scan_QRcode(self, img_url: str) -> Optional[str]:
        """
        æ‰«æimg_urlå¯¹åº”å›¾åƒä¸­çš„äºŒç»´ç 
        """

        try:
            image = self.url2image(img_url)
            if image:
                raw = pyzbar.decode(image)
                data = unquote(raw[0].data.decode('utf-8')) if raw else None
        except Exception as err:
            log.error(f"Failed to decode image. reason:{err}")
            data = None

        return data

    def has_img_hash(self, img_url: str) -> bool:
        """
        åˆ¤æ–­img_urlå¯¹åº”çš„å›¾åƒçš„dhashæ˜¯å¦åœ¨é»‘åå•ä¸­
        """

        image = self.url2image(img_url)
        if image:
            try:
                img_hash = str(imagehash.dhash(image))
            except OSError:
                return False
            if self.mysql.has_img_hash(self.tieba_name, img_hash):
                return True
            else:
                return False
        else:
            return False
