# å…¥é—¨æ•™ç¨‹

é˜…è¯»æœ¬æ•™ç¨‹ï¼Œä½ è‡³å°‘éœ€è¦å¯¹Pythonçš„ **ä¸Šä¸‹æ–‡ç®¡ç†å™¨** `with...as...` å’Œ **è¿­ä»£å™¨** `for...in...` æœ‰åŸºæœ¬çš„å°è±¡ï¼Œå› ä¸ºæœ¬æ–‡ä¸ä¼šå¯¹è¿™äº›é‡è¦çš„åŸºæœ¬æ¦‚å¿µåšè¿‡äºæ·±å…¥çš„è§£é‡Š

æ¨èåœ¨æœ¬åœ°æ–°å»ºä¸€ä¸ª`.py`æ–‡ä»¶æ¥è¿è¡Œæ ·ä¾‹

## å‘½åçº¦å®š

è´´å§æœåŠ¡ç«¯ä½¿ç”¨ä»¥ä¸‹åç§°è¡¨ç¤ºç‰¹å®šçš„æ•°æ®

### BDUSS

è´´å§æœåŠ¡ç«¯ä½¿ç”¨BDUSSæ¥ç¡®è®¤ç”¨æˆ·èº«ä»½

BDUSSæ˜¯ä¸€ä¸²ç”±çº¯asciiå­—ç¬¦ç»„æˆçš„ï¼Œé•¿åº¦ä¸º192çš„å­—ç¬¦ä¸²

!!! warning

    ä½¿ç”¨BDUSSå¯ä»¥å®Œæˆ**ä¸€åˆ‡**ä¸éœ€è¦æ‰‹æœº/é‚®ç®±éªŒè¯ç çš„æ“ä½œï¼ŒåŒ…æ‹¬**å‘å¸–**/**å‘ç§ä¿¡**/**è·å–è´¦å·ä¸Šçš„æ‰€æœ‰å†å²å‘è¨€**

    BDUSSçš„è¿‡æœŸæ—¶é—´é•¿è¾¾æ•°å¹´ï¼Œä¸€èˆ¬åªèƒ½é€šè¿‡é€€å‡ºç™»å½•æˆ–ä¿®æ”¹å¯†ç ä½¿å…¶å¤±æ•ˆ

    å› æ­¤å°†BDUSSæ³„éœ²ç»™ä¸å—ä¿¡ä»»çš„äººå¯èƒ½å¯¼è‡´é•¿æœŸçš„è´¦å·å®‰å…¨é£é™©å’Œéšç§æ³„éœ²é£é™©

åœ¨æµè§ˆå™¨çš„Cookieå’Œå„ç§è¡¨å•å‚æ•°ä¸­ä½ éƒ½èƒ½çœ‹åˆ°å®ƒçš„èº«å½±

æœç´¢ ä½ çš„æµè§ˆå™¨å‹å·+å¦‚ä½•æŸ¥çœ‹ç½‘ç«™çš„Cookie å°±èƒ½çŸ¥é“å¦‚ä½•è·å–ä½ çš„è´´å§è´¦å·çš„BDUSSäº†

ä»¥Chromeä¸ºä¾‹ï¼Œåœ¨ä»»ä½•ä¸€ä¸ªè´´å§ç½‘é¡µä¸‹æŒ‰<kbd>F12</kbd>è°ƒå‡ºå¼€å‘è€…é€‰é¡¹ï¼Œç„¶åä½ å°±èƒ½åœ¨ä¸‹å›¾çš„ä½ç½®æ‰¾åˆ°å®ƒ

![Chrome Cookie](https://user-images.githubusercontent.com/48282276/179938990-77139ea2-2d94-4d38-8d7d-9c6a3d99b69e.png)

### user_name

ç”¨æˆ·å

user_nameå”¯ä¸€ï¼Œä½†å¯å˜ï¼Œä¸”å¯ä»¥æ˜¯ç©ºå€¼

è¯·æ³¨æ„ä¸nick_nameç›¸åŒºåˆ†

### portrait

å¤´åƒID

æ¯ä¸ªè´´å§ç”¨æˆ·éƒ½æœ‰ä¸”ä»…æœ‰ä¸€ä¸ªportrait

portraitæ˜¯ä¸€ä¸²ç”±çº¯asciiå­—ç¬¦ç»„æˆçš„ï¼Œä»¥tb.1.ä½œä¸ºå¼€å¤´çš„ï¼Œé•¿åº¦ä¸º33~36çš„å­—ç¬¦ä¸²ï¼ˆä»…æœ‰ä¸€äº›è¿œå¤æ—¶æœŸçš„ipè´¦å·ä¸ç¬¦åˆè¿™ä¸ªè§„åˆ™ï¼‰

è­¬å¦‚æˆ‘çš„portraitå°±æ˜¯tb.1.8277e641.gUE2cTq4A4z5fi2EHn5k3Q

ä½ å¯ä»¥é€šè¿‡portraitè·å–ç”¨æˆ·å¤´åƒï¼Œä¾‹å¦‚[æˆ‘çš„å¤´åƒ](http://tb.himg.baidu.com/sys/portraith/item/tb.1.8277e641.gUE2cTq4A4z5fi2EHn5k3Q)

### user_id

ç”¨æˆ·ID

user_idå”¯ä¸€ï¼Œä¸å¯å˜ï¼Œä¸èƒ½ä¸ºç©º

è¯·æ³¨æ„å°†å…¶ä¸ç”¨æˆ·ä¸ªäººä¸»é¡µçš„tieba_uidç›¸åŒºåˆ†

user_idæ˜¯ä¸€ä¸ªint64å€¼

user_name portrait user_id éƒ½æ˜¯æ»¡è¶³å”¯ä¸€æ€§çš„ç”¨æˆ·æ ‡è¯†ç¬¦ï¼Œå¹¶å¯ä»¥é€šè¿‡å…¶ä¸­ä»»æ„ä¸€ä¸ªçš„å€¼åæŸ¥å…¶ä½™ä¸¤ä¸ª

### tieba_uid

ç”¨æˆ·ä¸ªäººä¸»é¡µID

tieba_uidå”¯ä¸€ï¼Œä¸å¯å˜ï¼Œä½†å¯ä»¥ä¸ºç©º

è¯·æ³¨æ„å°†å…¶ä¸ç”¨æˆ·çš„user_idç›¸åŒºåˆ†

tieba_uidæ˜¯ä¸€ä¸ªuint64å€¼ï¼ˆä»…æœ‰ä¸€äº›è¿œå¤æ—¶æœŸçš„ipè´¦å·ä¸ç¬¦åˆè¿™ä¸ªè§„åˆ™ï¼‰

å¯ä»¥é€šè¿‡tieba_uidçš„å€¼åæŸ¥user_name portrait user_id

### forum_id

å§IDï¼Œç®€ç§°fid

æ¯ä¸ªè´´å§éƒ½æœ‰ä¸”ä»…æœ‰ä¸€ä¸ªfid

### thread_id

ä¸»é¢˜å¸–IDï¼Œç®€ç§°tid

æ¯ä¸ªä¸»é¢˜å¸–éƒ½æœ‰ä¸”ä»…æœ‰ä¸€ä¸ªtid

### post_id

å›å¤IDï¼Œç®€ç§°pid

æ¯ä¸ªæ¥¼å±‚ã€æ¥¼ä¸­æ¥¼éƒ½æœ‰ä¸”ä»…æœ‰ä¸€ä¸ªpid

## å…³äºå¼‚æ­¥ç¼–ç¨‹

å¦‚æœä½ ä¸äº†è§£Pythonå¼‚æ­¥ç¼–ç¨‹ï¼Œè¯·å…ˆé˜…è¯»[å¼‚æ­¥ç¼–ç¨‹å…¥é—¨æ•™ç¨‹](async_start.md)

## è¿ˆå‡ºç¬¬ä¸€æ­¥

ä¸€ä¸ªéå¸¸ç®€å•çš„å…¥é—¨æ¡ˆä¾‹

### æ ·ä¾‹ä»£ç 

æœ¬æ ·ä¾‹å°†è·å–å¹¶æ‰“å°å½“å‰è´¦å·çš„ç”¨æˆ·ä¿¡æ¯

```python
import asyncio

import aiotieba as tb

BDUSS = "åœ¨è¿™é‡Œè¾“å…¥ä½ è´¦å·çš„BDUSS"


async def main():
    async with tb.Client(BDUSS) as client:
        user = await client.get_self_info()

    print(user)

asyncio.run(main())
```

### æœŸæœ›ç»“æœ

å¦‚æœä½ çš„[`BDUSS`](#bduss)å¡«å†™æ— è¯¯ï¼Œä½ ä¼šè·å¾—ç±»ä¼¼ä¸‹é¢è¿™æ ·çš„ç»“æœ

```log
Starry_OvO
```

## è¿è¡Œæ—¶æ›´æ”¹BDUSS

è¯¥æ¡ˆä¾‹æ¼”ç¤ºäº†å¦‚ä½•åœ¨è¿è¡Œæ—¶æ›´æ”¹BDUSS

å»ºè®®ä¸ºæ¯ä¸ªè´¦å·æ–°å»º`Client`ï¼Œä»¥é¿å…è¯¯ç”¨é—ç•™çš„websocketè¿æ¥

### æ ·ä¾‹ä»£ç 

æœ¬æ ·ä¾‹å°†è·å–å¹¶æ‰“å°å½“å‰è´¦å·çš„ç”¨æˆ·ä¿¡æ¯

```python
import asyncio

import aiotieba as tb


async def main():
    async with tb.Client() as client:
        client.account.BDUSS = "åœ¨è¿™é‡Œè¾“å…¥ä½ è´¦å·çš„BDUSS"
        user = await client.get_self_info()

    print(user)


asyncio.run(main())
```

### æœŸæœ›ç»“æœ

å¦‚æœä½ çš„[`BDUSS`](#bduss)å¡«å†™æ— è¯¯ï¼Œä½ ä¼šè·å¾—ç±»ä¼¼ä¸‹é¢è¿™æ ·çš„ç»“æœ

```log
Starry_OvO
```

## å¤šè´¦å·

å¦‚ä½•åŒæ—¶ä½¿ç”¨å¤šä¸ªè´¦å·ï¼Ÿ

### æ ·ä¾‹ä»£ç 

æœ¬æ ·ä¾‹å°†è·å–å¹¶æ‰“å°å¤šä¸ªè´¦å·çš„ç”¨æˆ·ä¿¡æ¯

```python
import asyncio

import aiotieba as tb

BDUSS1 = "åœ¨è¿™é‡Œè¾“å…¥ç¬¬ä¸€ä¸ªè´¦å·çš„BDUSS"
BDUSS2 = "åœ¨è¿™é‡Œè¾“å…¥ç¬¬äºŒä¸ªè´¦å·çš„BDUSS"


async def main():
    async with (tb.Client(BDUSS1) as client1, tb.Client(BDUSS2) as client2):
        user1 = await client1.get_self_info()
        user2 = await client2.get_self_info()
        print(f"è´¦å·1: {user1}, è´¦å·2: {user2}")


asyncio.run(main())
```

### æœŸæœ›ç»“æœ

å¦‚æœä½ çš„[`BDUSS`](#bduss)å¡«å†™æ— è¯¯ï¼Œä½ ä¼šè·å¾—ç±»ä¼¼ä¸‹é¢è¿™æ ·çš„ç»“æœ

```log
è´¦å·1: AAAA, è´¦å·2: BBBB
```

## ä½¿ç”¨STOKEN

åªæœ‰å°‘æ•°æ¥å£éœ€è¦ç”¨åˆ°`STOKEN`ï¼Œä¾‹å¦‚ç”¨äºè·å–è‡ªèº«å…³æ³¨å§åˆ—è¡¨çš„`get_self_follow_forums`

### æ ·ä¾‹ä»£ç 

æœ¬æ ·ä¾‹å°†è·å–å¹¶æ‰“å°å½“å‰è´¦å·çš„ä¸€éƒ¨åˆ†å…³æ³¨å§åˆ—è¡¨

```python
import asyncio

import aiotieba as tb

BDUSS = "åœ¨è¿™é‡Œè¾“å…¥ä½ è´¦å·çš„BDUSS"
STOKEN = "åœ¨è¿™é‡Œè¾“å…¥ä½ è´¦å·çš„ç½‘é¡µç«¯STOKEN"


async def main():
    account = tb.Account(BDUSS, STOKEN)
    async with tb.Client(account) as client:
        forums = await client.get_self_follow_forums()
        print(forums[:3])


asyncio.run(main())
```

### æœŸæœ›ç»“æœ

å¦‚æœä½ çš„[`BDUSS`](#bduss)å’Œ`STOKEN`å‡å¡«å†™æ— è¯¯ï¼Œä½ ä¼šè·å¾—ç±»ä¼¼ä¸‹é¢è¿™æ ·çš„ç»“æœ

```log
[SelfFollowForum(fid=1999, fname='å¯åŠ¨ï¼', level=1), SelfFollowForum(fid=1999, fname='å¯åŠ¨ï¼', level=1), SelfFollowForum(fid=1999, fname='å¯åŠ¨ï¼', level=1)]
```

## Accountçš„åºåˆ—åŒ–ä¸ååºåˆ—åŒ–

è¯¥åŠŸèƒ½å¯ä»¥ç”¨äºå¯¼å‡ºè´¦å·å‚æ•°

### æ ·ä¾‹ä»£ç 

æœ¬æ ·ä¾‹å°†æ¼”ç¤ºè´¦å·å‚æ•°çš„å¯¼å‡ºä¸å¯¼å…¥ï¼Œå¹¶ä½¿ç”¨å¯¼å…¥ç”Ÿæˆçš„Accountè·å–ç”¨æˆ·ä¿¡æ¯

```python
import asyncio

import aiotieba as tb

BDUSS = "åœ¨è¿™é‡Œè¾“å…¥ä½ è´¦å·çš„BDUSS"


async def main():
    account1 = tb.Account(BDUSS)
    dic = account1.to_dict()
    print(dic)
    account2 = tb.Account.from_dict(dic)
    assert account1.BDUSS == account2.BDUSS

    async with tb.Client(account2) as client:
        user = await client.get_self_info()

    print(user)


asyncio.run(main())
```

### æœŸæœ›ç»“æœ

å¦‚æœä½ çš„[`BDUSS`](#bduss)å¡«å†™æ— è¯¯ï¼Œä½ ä¼šè·å¾—ç±»ä¼¼ä¸‹é¢è¿™æ ·çš„ç»“æœ

```log
{'BDUSS': '...'}
Starry_OvO
```

## ç®€å•å¹¶å‘çˆ¬è™«

### æ ·ä¾‹ä»£ç 

æœ¬æ ·ä¾‹å°†åŒæ—¶è¯·æ±‚ç”¨æˆ·ä¸ªäººä¿¡æ¯å’Œå¤©å ‚é¸¡æ±¤å§é¦–é¡µå‰30å¸–ï¼Œå¹¶å°†ä»–ä»¬æ‰“å°å‡ºæ¥

```python
import asyncio

import aiotieba as tb

BDUSS = "åœ¨è¿™é‡Œè¾“å…¥ä½ è´¦å·çš„BDUSS"

async def main():
    async with tb.Client(BDUSS) as client:
        # [1] ä»€ä¹ˆæ˜¯`asyncio.gather`ï¼Ÿ
        # å‚è€ƒå®˜æ–¹æ–‡æ¡£ï¼šå¹¶å‘è¿è¡Œä»»åŠ¡
        # https://docs.python.org/zh-cn/3/library/asyncio-task.html#running-tasks-concurrently
        user, threads = await asyncio.gather(client.get_self_info(), client.get_threads('å¤©å ‚é¸¡æ±¤'))

    # å°†è·å–çš„ä¿¡æ¯æ‰“å°åˆ°æ—¥å¿—
    print(f"å½“å‰ç”¨æˆ·: {user}")
    for thread in threads:
        # Threadsæ”¯æŒè¿­ä»£ï¼Œå› æ­¤å¯ä»¥ä½¿ç”¨forå¾ªç¯é€æ¡æ‰“å°ä¸»é¢˜å¸–ä¿¡æ¯
        # å½“ç„¶äº†ï¼ŒThreadsä¹Ÿæ”¯æŒä½¿ç”¨ä¸‹æ ‡çš„éšæœºè®¿é—®
        print(f"tid: {thread.tid} æœ€åå›å¤æ—¶é—´æˆ³: {thread.last_time} æ ‡é¢˜: {thread.title}")


# ä½¿ç”¨asyncio.runæ‰§è¡Œåç¨‹main
asyncio.run(main())
```

### æ ·ä¾‹è§£æ

#### ä»€ä¹ˆæ˜¯`asyncio.gather`ï¼Ÿ

ä½ å¯ä»¥å°†è‹¥å¹²åç¨‹ä½œä¸ºå‚æ•°ä¼ å…¥`asyncio.gather`ï¼Œæ ·ä¾‹ä¸­ä¼ å…¥äº†ä¸¤ä¸ªåç¨‹ã€‚å¦‚æœä½ å¿˜è®°äº†åç¨‹å’Œå¼‚æ­¥å‡½æ•°ä¹‹é—´çš„åŒºåˆ«ï¼Œè¯·åŠæ—¶å¤ä¹ ã€‚

`asyncio.gather`ä¼šä¸ºæ¯ä¸ªä¼ å…¥çš„åç¨‹åˆ›å»ºå¯¹åº”çš„ä»»åŠ¡æ¥åŒæ—¶æ‰§è¡Œå®ƒä»¬ï¼ˆå¹¶å‘ï¼‰ï¼ŒåŒæ—¶`asyncio.gather(...)`è‡ªèº«ä¹Ÿæ˜¯ä¸€ä¸ªåç¨‹ï¼Œåœ¨å‰é¢æ·»åŠ `await`ä»¥è¦æ±‚ä¸»åç¨‹`main()`ç­‰å¾…å…¶æ‰§è¡Œå®Œæ¯•ã€‚æ‰§è¡Œå®Œæ¯•åï¼Œè¿”å›æ•°æ®çš„é¡ºåºä¸ä¼ å…¥åç¨‹çš„é¡ºåºä¸€è‡´ï¼Œå³`user`å¯¹åº”`client.get_self_info()`ï¼Œ`threads`å¯¹åº”`client.get_threads(...)`

### æœŸæœ›ç»“æœ

è¿è¡Œæ•ˆæœå¦‚ä¸‹æ‰€ç¤º

```log
å½“å‰ç”¨æˆ·: Starry_OvO
tid: 7595618217 æœ€åå›å¤æ—¶é—´æˆ³: 1672461980 æ ‡é¢˜: å…³äºè´Ÿèƒ½é‡å¸–å­çš„æœ€æ–°è§„å®š
tid: 8204562074 æœ€åå›å¤æ—¶é—´æˆ³: 1672502281 æ ‡é¢˜: å¤–å–è¶…æ—¶é€€å•ï¼Œå¿ƒç†ç…ç†¬
tid: 8165883863 æœ€åå›å¤æ—¶é—´æˆ³: 1672502270 æ ‡é¢˜: ã€è®°å½•ã€‘æˆ‘è¿™åŠé†‰åŠé†’çš„äººç”Ÿå•Š
tid: 8204618726 æœ€åå›å¤æ—¶é—´æˆ³: 1672502254 æ ‡é¢˜: è®°å½•ä¸€ä¸‹ç¼–å¯¼ç”Ÿçš„æ—¥å¸¸
tid: 8202743003 æœ€åå›å¤æ—¶é—´æˆ³: 1672502252 æ ‡é¢˜: 2023ä¼šæ›´å¥½å—ï¼Ÿæˆ–è€…ï¼Œåˆæ˜¯ä¸€å¹´çš„ç¢Œç¢Œæ— ä¸º
tid: 8204456677 æœ€åå›å¤æ—¶é—´æˆ³: 1672502301 æ ‡é¢˜: 2023æ–°å¹´å€’è®¡æ—¶å¼€å§‹ï¼Œæœ‰äººçš„è¯è¯·å›å¤
tid: 8203409990 æœ€åå›å¤æ—¶é—´æˆ³: 1672502197 æ ‡é¢˜: å¹´å°¾äº†ï¼Œè°¢è°¢ä½ ä»¬
tid: 8203959170 æœ€åå›å¤æ—¶é—´æˆ³: 1672502156 æ ‡é¢˜: æ±‚ç¥ç¦
tid: 8188549079 æœ€åå›å¤æ—¶é—´æˆ³: 1672502122 æ ‡é¢˜: pollen's club
tid: 8204240728 æœ€åå›å¤æ—¶é—´æˆ³: 1672502091 æ ‡é¢˜: è¿™æ˜¯å­©å­æœ€è´µé‡çš„ä¸œè¥¿
tid: 8200916354 æœ€åå›å¤æ—¶é—´æˆ³: 1672502023 æ ‡é¢˜: è¿™ä¸ªæ˜¯çœŸçš„å—
tid: 8204206290 æœ€åå›å¤æ—¶é—´æˆ³: 1672501931 æ ‡é¢˜: å®¶é‡Œçªç„¶å¤šäº†åªç‹—ï¼Œè¯·å¤§å®¶å–ä¸ªåå­—
tid: 8204353842 æœ€åå›å¤æ—¶é—´æˆ³: 1672501936 æ ‡é¢˜: ä¸€ä¸ªå¾ˆå¥½çš„å¤–å–å°å“¥
tid: 8204583367 æœ€åå›å¤æ—¶é—´æˆ³: 1672501911 æ ‡é¢˜: ä½•ç­‰å¥‡è¿¹ï¼åšéŸ§çµé­‚ï¼
tid: 8204431580 æœ€åå›å¤æ—¶é—´æˆ³: 1672501835 æ ‡é¢˜: å¤§å®¶ä»Šå¹´æƒ³æ€ä¹ˆè·¨å¹´å‘¢ï¼Ÿ
tid: 8204442527 æœ€åå›å¤æ—¶é—´æˆ³: 1672501832 æ ‡é¢˜: å§å‹ä»¬ï¼Œå¿«è¿‡å¹´äº†èƒ½ä¸èƒ½å‘ä¸€äº›æ¸©é¦¨å¯çˆ±çš„å›¾
tid: 8202573308 æœ€åå›å¤æ—¶é—´æˆ³: 1672501923 æ ‡é¢˜:
tid: 8202504004 æœ€åå›å¤æ—¶é—´æˆ³: 1672501740 æ ‡é¢˜: å§å‹ä»¬ï¼Œæƒ³å¬åˆ°é‚£4ä¸ªå­—
tid: 8203284120 æœ€åå›å¤æ—¶é—´æˆ³: 1672501971 æ ‡é¢˜: çœ‹åˆ°è¯„è®ºåŒº è§‰å¾—å¾ˆæš–å¿ƒ æƒ³ç»™å§å‹åˆ†äº«åˆ†äº«
tid: 8203290932 æœ€åå›å¤æ—¶é—´æˆ³: 1672502300 æ ‡é¢˜:
tid: 8202592714 æœ€åå›å¤æ—¶é—´æˆ³: 1672501686 æ ‡é¢˜: ä¸è¦èµ°å•Šç‹—ç‹—
tid: 8165292224 æœ€åå›å¤æ—¶é—´æˆ³: 1672501498 æ ‡é¢˜: ä½ æƒ³è¦åªè‚¥å•¾å—ï¼Ÿ
tid: 8202351346 æœ€åå›å¤æ—¶é—´æˆ³: 1672501588 æ ‡é¢˜: è¿™å°±æ˜¯ç¼˜åˆ†å—ï¼Ÿ
tid: 8204609134 æœ€åå›å¤æ—¶é—´æˆ³: 1672501304 æ ‡é¢˜:
tid: 8204575619 æœ€åå›å¤æ—¶é—´æˆ³: 1672501526 æ ‡é¢˜: æ ‡é¢˜äº”ä¸ªå­—
tid: 8199583210 æœ€åå›å¤æ—¶é—´æˆ³: 1672501343 æ ‡é¢˜: ä¸€äº›æœ‰è¶£çš„å›¾å›¾
tid: 8204401395 æœ€åå›å¤æ—¶é—´æˆ³: 1672494092 æ ‡é¢˜: å…„å¼Ÿä»¬  åˆæ¥ä¹åˆ°
tid: 8200191186 æœ€åå›å¤æ—¶é—´æˆ³: 1672500928 æ ‡é¢˜: æˆ‘å¦ˆåšäº†ä¸€ä»¶å¥½äº‹
tid: 8204273523 æœ€åå›å¤æ—¶é—´æˆ³: 1672500829 æ ‡é¢˜: ä½ å¦‚åˆå¾…æˆ‘æ¨¡æ ·
```

## ä»»åŠ¡é˜Ÿåˆ—å®ç°å¤šåç¨‹çˆ¬è™«

### æ ·ä¾‹ä»£ç 

æœ¬æ ·ä¾‹å°†é€šè¿‡ä»»åŠ¡é˜Ÿåˆ—å®ç°ä¸€ä¸ªå¤šåç¨‹çˆ¬è™«ï¼Œå¿«é€Ÿçˆ¬å–å¤©å ‚é¸¡æ±¤å§çš„å‰32é¡µå…±960æ¡ä¸»é¢˜å¸–ï¼Œå¹¶æ‰“å°å…¶ä¸­æµè§ˆé‡æœ€é«˜çš„10æ¡

```python
import asyncio
import time
from typing import List

import aiotieba as tb
from aiotieba.logging import get_logger as LOG

BDUSS = "åœ¨è¿™é‡Œè¾“å…¥ä½ è´¦å·çš„BDUSS"


async def crawler(fname: str):
    """
    è·å–è´´å§åä¸ºfnameçš„è´´å§çš„å‰32é¡µä¸­æµè§ˆé‡æœ€é«˜çš„10ä¸ªä¸»é¢˜å¸–

    Args:
        fname (str): è´´å§å
    """

    start_time = time.perf_counter()
    LOG().info("Spider start")

    # thread_listç”¨æ¥ä¿å­˜ä¸»é¢˜å¸–åˆ—è¡¨
    thread_list: List[tb.typing.Thread] = []

    # ä½¿ç”¨é”®å"default"å¯¹åº”çš„BDUSSåˆ›å»ºå®¢æˆ·ç«¯
    async with tb.Client(BDUSS) as client:
        # asyncio.Queueæ˜¯ä¸€ä¸ªä»»åŠ¡é˜Ÿåˆ—
        # maxsize=8æ„å‘³ç€ç¼“å†²åŒºé•¿åº¦ä¸º8
        # å½“ç¼“å†²åŒºè¢«å¡«æ»¡æ—¶ï¼Œè°ƒç”¨Queue.putçš„åç¨‹ä¼šè¢«é˜»å¡
        task_queue = asyncio.Queue(maxsize=8)
        # å½“is_runningè¢«è®¾ä¸ºFalseåï¼Œæ¶ˆè´¹è€…ä¼šåœ¨è¶…æ—¶åé€€å‡º
        is_running = True

        async def producer():
            """
            ç”Ÿäº§è€…åç¨‹
            """

            for pn in range(32, 0, -1):
                # ç”Ÿäº§è€…ä½¿ç”¨Queue.putä¸æ–­åœ°å°†é¡µç pnå¡«å…¥ä»»åŠ¡é˜Ÿåˆ—task_queue
                await task_queue.put(pn)
            # è¿™é‡Œéœ€è¦nonlocalæ¥å…è®¸å¯¹é—­åŒ…å¤–çš„å˜é‡çš„ä¿®æ”¹æ“ä½œï¼ˆç±»ä¼¼äºå¼•ç”¨ä¼ é€’å’Œå€¼ä¼ é€’çš„åŒºåˆ«ï¼‰
            nonlocal is_running
            # å°†is_runningè®¾ç½®ä¸ºFalseä»¥å…è®¸å„æ¶ˆè´¹åç¨‹è¶…æ—¶é€€å‡º
            is_running = False

        async def worker(i: int):
            """
            æ¶ˆè´¹è€…åç¨‹

            Args:
                i (int): åç¨‹ç¼–å·
            """

            while 1:
                try:
                    # æ¶ˆè´¹è€…åç¨‹ä¸æ–­åœ°ä½¿ç”¨Queue.getä»task_queueä¸­æ‹‰å–ç”±ç”Ÿäº§è€…åç¨‹æä¾›çš„é¡µç pnä½œä¸ºä»»åŠ¡
                    # asyncio.wait_forä¼šç­‰å¾…ä½œä¸ºå‚æ•°çš„åç¨‹æ‰§è¡Œå®Œæ¯•ç›´åˆ°è¶…æ—¶
                    # timeout=1å³æŠŠè¶…æ—¶æ—¶é—´è®¾ä¸º1ç§’
                    # å¦‚æœè¶…è¿‡1ç§’æœªè·å–åˆ°æ–°çš„é¡µç pnï¼Œasyncio.wait_for(...)å°†æŠ›å‡ºasyncio.TimeoutError
                    pn = await asyncio.wait_for(task_queue.get(), timeout=1)
                    LOG().debug(f"Worker#{i} handling pn:{pn}")
                except asyncio.TimeoutError:
                    # æ•è·asyncio.TimeoutErrorä»¥é€€å‡ºåç¨‹
                    if is_running is False:
                        # å¦‚æœis_runningä¸ºFalseï¼Œæ„å‘³ç€ä¸éœ€è¦å†è½®è¯¢task_queueè·å–æ–°ä»»åŠ¡
                        LOG().debug(f"Worker#{i} quit")
                        # æ¶ˆè´¹è€…åç¨‹é€šè¿‡returné€€å‡º
                        return
                else:
                    # æ‰§è¡Œè¢«åˆ†æ´¾çš„ä»»åŠ¡ï¼Œå³çˆ¬å–pné¡µçš„å¸–å­åˆ—è¡¨
                    threads = await client.get_threads(fname, pn)
                    # è¿™é‡Œçš„nonlocalåŒæ ·æ˜¯ä¸ºäº†ä¿®æ”¹é—­åŒ…å¤–çš„å˜é‡thread_list
                    nonlocal thread_list
                    thread_list += threads

        # åˆ›å»º8ä¸ªæ¶ˆè´¹è€…åç¨‹
        workers = [worker(i) for i in range(8)]
        # ä½¿ç”¨asyncio.gatherå¹¶å‘æ‰§è¡Œ
        # éœ€è¦æ³¨æ„è¿™é‡Œ*workersä¸­çš„*æ„ä¸ºå°†åˆ—è¡¨å±•å¼€æˆå¤šä¸ªå‚æ•°
        # å› ä¸ºasyncio.gatheråªæ¥å—åç¨‹ä½œä¸ºå‚æ•°ï¼Œä¸æ¥å—åç¨‹åˆ—è¡¨
        await asyncio.gather(*workers, producer())

    LOG().info(f"Spider complete. Time cost: {time.perf_counter()-start_time:.4f} secs")

    # æŒ‰ä¸»é¢˜å¸–æµè§ˆé‡é™åºæ’åº
    thread_list.sort(key=lambda thread: thread.view_num, reverse=True)
    # å°†æµè§ˆé‡æœ€é«˜çš„10ä¸ªä¸»é¢˜å¸–çš„ä¿¡æ¯æ‰“å°åˆ°æ—¥å¿—
    for i, thread in enumerate(thread_list[0:10], 1):
        LOG().info(f"Rank#{i} view_num:{thread.view_num} title:{thread.title}")


# æ‰§è¡Œåç¨‹crawler
asyncio.run(crawler("å¤©å ‚é¸¡æ±¤"))
```

### æœŸæœ›ç»“æœ

è¿è¡Œæ•ˆæœå¦‚ä¸‹å›¾æ‰€ç¤º

```log
<2023-01-01 00:03:01.195> [INFO] [crawler] Spider start
<2023-01-01 00:03:01.198> [DEBUG] [worker] Worker#0 handling pn:32
<2023-01-01 00:03:01.242> [DEBUG] [worker] Worker#1 handling pn:31
<2023-01-01 00:03:01.245> [DEBUG] [worker] Worker#2 handling pn:30
<2023-01-01 00:03:01.245> [DEBUG] [worker] Worker#3 handling pn:29
<2023-01-01 00:03:01.246> [DEBUG] [worker] Worker#4 handling pn:28
<2023-01-01 00:03:01.247> [DEBUG] [worker] Worker#5 handling pn:27
<2023-01-01 00:03:01.248> [DEBUG] [worker] Worker#6 handling pn:26
<2023-01-01 00:03:01.248> [DEBUG] [worker] Worker#7 handling pn:25
<2023-01-01 00:03:01.599> [DEBUG] [worker] Worker#7 handling pn:24
<2023-01-01 00:03:01.626> [DEBUG] [worker] Worker#4 handling pn:23
<2023-01-01 00:03:01.685> [DEBUG] [worker] Worker#2 handling pn:22
<2023-01-01 00:03:01.711> [DEBUG] [worker] Worker#5 handling pn:21
<2023-01-01 00:03:01.744> [DEBUG] [worker] Worker#3 handling pn:20
<2023-01-01 00:03:01.768> [DEBUG] [worker] Worker#0 handling pn:19
<2023-01-01 00:03:01.776> [DEBUG] [worker] Worker#1 handling pn:18
<2023-01-01 00:03:01.777> [DEBUG] [worker] Worker#6 handling pn:17
<2023-01-01 00:03:01.974> [DEBUG] [worker] Worker#5 handling pn:16
<2023-01-01 00:03:02.041> [DEBUG] [worker] Worker#7 handling pn:15
<2023-01-01 00:03:02.043> [DEBUG] [worker] Worker#4 handling pn:14
<2023-01-01 00:03:02.072> [DEBUG] [worker] Worker#6 handling pn:13
<2023-01-01 00:03:02.083> [DEBUG] [worker] Worker#2 handling pn:12
<2023-01-01 00:03:02.145> [DEBUG] [worker] Worker#3 handling pn:11
<2023-01-01 00:03:02.190> [DEBUG] [worker] Worker#0 handling pn:10
<2023-01-01 00:03:02.197> [DEBUG] [worker] Worker#1 handling pn:9
<2023-01-01 00:03:02.365> [DEBUG] [worker] Worker#7 handling pn:8
<2023-01-01 00:03:02.379> [DEBUG] [worker] Worker#2 handling pn:7
<2023-01-01 00:03:02.425> [DEBUG] [worker] Worker#5 handling pn:6
<2023-01-01 00:03:02.547> [DEBUG] [worker] Worker#6 handling pn:5
<2023-01-01 00:03:02.579> [DEBUG] [worker] Worker#4 handling pn:4
<2023-01-01 00:03:02.606> [DEBUG] [worker] Worker#3 handling pn:3
<2023-01-01 00:03:02.635> [DEBUG] [worker] Worker#0 handling pn:2
<2023-01-01 00:03:02.640> [DEBUG] [worker] Worker#1 handling pn:1
<2023-01-01 00:03:03.789> [DEBUG] [worker] Worker#5 quit
<2023-01-01 00:03:03.820> [DEBUG] [worker] Worker#7 quit
<2023-01-01 00:03:03.821> [DEBUG] [worker] Worker#2 quit
<2023-01-01 00:03:03.821> [DEBUG] [worker] Worker#6 quit
<2023-01-01 00:03:03.882> [DEBUG] [worker] Worker#4 quit
<2023-01-01 00:03:03.975> [DEBUG] [worker] Worker#0 quit
<2023-01-01 00:03:03.975> [DEBUG] [worker] Worker#1 quit
<2023-01-01 00:03:03.976> [INFO] [crawler] Spider complete. Time cost: 2.7822 secs
<2023-01-01 00:03:03.977> [INFO] [crawler] Rank#1 view_num:295571 title:å„ä½å‘ç‚¹æš–å¿ƒå°æ•…äº‹å§æˆ‘å…ˆæ¥
<2023-01-01 00:03:03.978> [INFO] [crawler] Rank#2 view_num:285897 title:è§£å†³å‹åŠ›å¤§
<2023-01-01 00:03:03.978> [INFO] [crawler] Rank#3 view_num:255771 title:äººæ´»ç€æ˜¯ä¸ºäº†ä»€ä¹ˆ
<2023-01-01 00:03:03.978> [INFO] [crawler] Rank#4 view_num:243325 title:é¢è—•ï¼Œæˆ‘çš„é¢è—•ğŸ˜­
<2023-01-01 00:03:03.979> [INFO] [crawler] Rank#5 view_num:222611 title:ä»€ä¹ˆäº‹æƒ…æ˜¯ä½ é•¿å¤§å¾ˆä¹…ä¹‹åæ‰æ˜ç™½çš„ï¼Ÿ
<2023-01-01 00:03:03.979> [INFO] [crawler] Rank#6 view_num:216527 title:æ•™ä½ è°ˆæ‹çˆ±
<2023-01-01 00:03:03.979> [INFO] [crawler] Rank#7 view_num:214848 title:ä½ å·²ç»æ˜¯åªç‹—äº†ï¼
<2023-01-01 00:03:03.980> [INFO] [crawler] Rank#8 view_num:208130 title:å¥½æ¸©æš–å‘€~
<2023-01-01 00:03:03.980> [INFO] [crawler] Rank#9 view_num:206946 title:å¥½æ¸©æŸ”çš„å”å”å•ŠğŸ˜­
<2023-01-01 00:03:03.980> [INFO] [crawler] Rank#10 view_num:203606 title:ä½ ä¼šä¸ä¼šåˆ æ‰å·²æ•…äº²äººçš„è”ç³»æ–¹å¼ï¼Ÿ
```
