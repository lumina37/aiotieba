# aiotiebaåº“ä½¿ç”¨æ•™ç¨‹

## å‡†å¤‡çŸ¥è¯†

æƒ³è¦ç”¨å¥½`aiotieba`åº“ï¼Œå¿…é¡»åˆæ­¥æŒæ¡`Python`å¼‚æ­¥ç¼–ç¨‹

å¦‚æœä½ ä¸ç†Ÿæ‚‰`Python`å¼‚æ­¥ç¼–ç¨‹ï¼Œå»ºè®®é˜…è¯»ä¸‹åˆ—æ•™ç¨‹ï¼š

+ [è½»æ¾ç†è§£Pythonä¸­çš„async/await](https://blog.csdn.net/Likianta/article/details/90123678) éå¸¸æ˜“äºç†è§£çš„å…¥é—¨æ¡ˆä¾‹
+ [Pythonå®˜æ–¹æ–‡æ¡£ åç¨‹ä¸ä»»åŠ¡](https://docs.python.org/zh-cn/3/library/asyncio-task.html) åŒ…å«è¯¦å°½Referenceå’Œé…å¥—æ¡ˆä¾‹çš„å®˜æ–¹æ–‡æ¡£ï¼Œæ›´é€‚åˆæœ‰ä¸€å®šåŸºç¡€çš„åˆå­¦è€…
+ [Python Async/Awaitå…¥é—¨æŒ‡å—](https://zhuanlan.zhihu.com/p/27258289) å·²ç»æ˜¯17å¹´çš„æ–‡ç« äº†ï¼Œä»ç”Ÿæˆå™¨`yield`çš„è§’åº¦å‡ºå‘ä»‹ç»`Python`å¼‚æ­¥ï¼Œå¯¹åˆå­¦è€…ä¸å¤ªå‹å¥½ï¼Œæ›´é€‚åˆæ‹”é«˜é˜…è¯»
+ [æ·±å…¥ç†è§£JavaScriptä¸­çš„async/await](https://www.cnblogs.com/youma/p/10475214.html) `JavaScript`ä¸­çš„`Promise`ä¸`Python`ä¸­çš„`Future`æ¦‚å¿µå¾ˆç›¸ä¼¼ï¼Œè¯¥æ•™ç¨‹å¯ä»¥å¸®åŠ©ä½ å¿«é€Ÿåœ°ä»`Promise`å¼‚æ­¥æ¨¡å¼å‡ºå‘ç†è§£`async-await`å¼‚æ­¥æ¨¡å¼

å¦‚æœä½ å·²ç»å¯¹å¼‚æ­¥ç¼–ç¨‹çš„ç›¸å…³çŸ¥è¯†éå¸¸ç†Ÿæ‚‰ï¼Œé‚£ä¹ˆæˆ‘å»ºè®®ä½ æŒ‰`4-1-2-3`çš„é¡ºåºé˜…è¯»

å¦‚æœä½ åªæ˜¯ç¼–ç¨‹åˆå­¦è€…æˆ–è€…å¯¹å„ç§å¼‚æ­¥æ¨¡å¼ä¸€çªä¸é€šï¼Œé‚£ä¹ˆæˆ‘å»ºè®®ä½ æŒ‰`1-2-3`çš„é¡ºåºé˜…è¯»

å½“ç„¶å³ä¾¿ä½ æ²¡æœ‰é˜…è¯»ä¸Šé¢çš„æ•™ç¨‹ï¼Œæˆ‘ä¹Ÿä¼šé’ˆå¯¹å¼‚æ­¥ç¼–ç¨‹çš„åˆå­¦è€…ä¸ºæ¯ä¸€è¡Œå¼‚æ­¥ä»£ç æ’°å†™è¯¦ç»†çš„æ³¨é‡Š

## æ¡ˆä¾‹1 é…ç½®BDUSS

æœ¬ä¾‹ä¸­ï¼Œä½ å°†å­¦ä¼š`config.toml`é…ç½®æ–‡ä»¶çš„åŸºæœ¬å¡«å†™æ–¹æ³•ï¼Œå¹¶ä½¿ç”¨`aiotieba`åº“è·å–è´´å§è´¦å·çš„éæ•æ„Ÿä¸ªäººä¿¡æ¯

### æ­¥éª¤1

åœ¨`aiotieba`æ–‡ä»¶å¤¹çš„æ—è¾¹æ–°å»ºä¸€ä¸ª`debug.py`æ–‡ä»¶ã€‚å½“ç„¶ä½ ä¹Ÿå¯ä»¥åœ¨ä»»ä½•ä¸€ä¸ªå¯ä»¥å¼•ç”¨åˆ°`aiotieba`åº“çš„åœ°æ–¹æ–°å»ºè„šæœ¬ï¼Œåˆæˆ–æ˜¯å¦èµ·ä¸€ä¸ªä½ å–œæ¬¢çš„è„šæœ¬å

å°†ä¸‹åˆ—ä»£ç å¤åˆ¶åˆ°`debug.py`å¹¶è¿è¡Œ

```python
import asyncio

import aiotieba as tb


# å®šä¹‰å¼‚æ­¥å‡½æ•°main
# éœ€è¦æ˜ç¡®async def...å’Œdef...åœ¨å®šä¹‰å‡½æ•°ä¸Šçš„åŒºåˆ«
# å¯¹äºdefå®šä¹‰çš„åŒæ­¥å‡½æ•°funcï¼Œfunc()ä¼šç›´æ¥è¿”å›ç»“æœ
# è€Œå¯¹äºasync defå®šä¹‰çš„å¼‚æ­¥å‡½æ•°afuncï¼Œafunc()åªä¼šè¿”å›ä¸€ä¸ªå¯ç­‰å¾…ï¼ˆAwaitableï¼‰çš„åç¨‹
# ä½ éœ€è¦ä½¿ç”¨awaitæˆ–asyncio.runæˆ–å…¶ä»–è¯­å¥æ¥ç­‰å¾…åç¨‹æ‰§è¡Œå®Œæ¯•åæ‰èƒ½æ‹¿åˆ°è¿”å›ç»“æœ
async def main():
    # ä½¿ç”¨é”®å"default"å¯¹åº”çš„BDUSSåˆ›å»ºå®¢æˆ·ç«¯
    # async withä¼šå…ˆè°ƒç”¨tb.Clientçš„__init__æ–¹æ³•åŒæ­¥åœ°åˆ›å»ºä¸€ä¸ªå®ä¾‹
    # å†å¼‚æ­¥è°ƒç”¨__aenter__æ–¹æ³•æ¥è‡ªåŠ¨å®Œæˆä¸€äº›èµ„æºåˆå§‹åŒ–å·¥ä½œï¼ˆå¦‚åˆ›å»ºè¿æ¥æ± ï¼‰ï¼Œå¹¶å°†è¿”å›å€¼èµ‹ç»™clientå˜é‡
    # æœ€åï¼Œåœ¨async withçš„ä½œç”¨åŸŸç»“æŸæ—¶ï¼Œtb.Clientçš„__aexit__æ–¹æ³•ä¼šè¢«è‡ªåŠ¨åœ°å¼‚æ­¥è°ƒç”¨ä»¥å®Œæˆä¸€äº›æ¸…ç†å·¥ä½œï¼ˆå¦‚å…³é—­æ‰€æœ‰è¿æ¥å¹¶é‡Šæ”¾èµ„æºï¼‰
    # async with...as...ä¸with...as...çš„ç”¨é€”ç±»ä¼¼ï¼Œéƒ½æ˜¯ä¸ºäº†å®ç°ä¼˜é›…çš„åˆå§‹åŒ–æ“ä½œä¸é€€å‡ºæ“ä½œ
    # åŒºåˆ«ä»…ä»…åœ¨äºå‰è€…è°ƒç”¨çš„__aenter__å’Œ__aexit__éƒ½æ˜¯å¼‚æ­¥æ–¹æ³•ï¼Œè€Œåè€…è°ƒç”¨çš„__enter__å’Œ__exit__éƒ½æ˜¯åŒæ­¥æ–¹æ³•
    # å‚è€ƒå®˜æ–¹æ–‡æ¡£ï¼šå¼‚æ­¥ä¸Šä¸‹æ–‡ç®¡ç†å™¨
    # https://docs.python.org/zh-cn/3/reference/datamodel.html#asynchronous-context-managers
    async with tb.Client("default") as client:
        # client.get_self_info()æ˜¯ä¸€ä¸ªåç¨‹å¯¹è±¡
        # é€šè¿‡åœ¨å®ƒå‰é¢æ·»åŠ ä¸€ä¸ªawaitè¯­å¥ï¼Œæˆ‘ä»¬å¯ä»¥ä»¥ä¸€ç§éé˜»å¡çš„æ–¹å¼ç­‰å¾…å®ƒæ‰§è¡Œå®Œæ¯•
        # è¯¥åç¨‹æ‰§è¡Œå®Œæ¯•æ—¶ï¼Œå°†ä¼šè¿”å›å¯¹åº”è´´å§è´¦å·çš„éæ•æ„Ÿä¸ªäººä¿¡æ¯
        # å‚è€ƒå®˜æ–¹æ–‡æ¡£ï¼šå¯ç­‰å¾…å¯¹è±¡
        # https://docs.python.org/zh-cn/3/library/asyncio-task.html#awaitables
        user = await client.get_self_info()

    # å°†è·å–çš„ä¿¡æ¯æ‰“å°åˆ°æ—¥å¿—
    tb.LOG.info(f"å½“å‰ç”¨æˆ·ä¿¡æ¯: {user}")


# æ‰§è¡Œåç¨‹main()
# å‚è€ƒå®˜æ–¹æ–‡æ¡£ï¼šè¿è¡Œasyncioç¨‹åº
# https://docs.python.org/zh-cn/3/library/asyncio-task.html#running-an-asyncio-program
asyncio.run(main())
```

ç„¶åï¼Œä½ ä¼šè·å¾—å¦‚ä¸‹ç»“æœ

```log
<2022-06-24 21:42:36> [WARNING] Failed to login. reason:ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯
<2022-06-24 21:42:36> [INFO] å½“å‰ç”¨æˆ·ä¿¡æ¯: BasicUserInfo [user_id:0 / user_name: / portrait: / nick_name:]
```

### æ­¥éª¤2

æ­¤æ—¶åœ¨`debug.py`çš„åŒçº§ç›®å½•ä¸‹ä¼šç”Ÿæˆä¸€ä¸ª`config`æ–‡ä»¶å¤¹ï¼Œç‚¹å¼€é‡Œé¢è‡ªåŠ¨ç”Ÿæˆçš„`config.toml`æ–‡ä»¶ï¼Œå°†ä½ çš„`BDUSS`å¡«å…¥æ­£ç¡®çš„ä½ç½®

`BDUSS`çš„æå–æ–¹å¼è¯·è‡ªè¡Œæœç´¢[æµè§ˆå™¨å¦‚ä½•è·å–BDUSS](https://cn.bing.com/search?q=%E6%B5%8F%E8%A7%88%E5%99%A8%E5%A6%82%E4%BD%95%E8%8E%B7%E5%8F%96BDUSS)

å¡«å†™å®Œæ¯•çš„`config.toml`å¤§æ¦‚é•¿è¿™æ ·

```toml
[User]

[User.default]
BDUSS = "2dNNk1wMXVSZmw2MnpkWDNqMnM4MmFaeFZYNVVPUEhPS0thNFZzUERjME52V1KpSVFBQUFBJCQAAAAAAQAAAAEAAAA0lUwndl9ndWFyZAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA0wPmINMD5iY" # æŠŠä½ çš„é‚£ä¸€ä¸²é•¿é•¿çš„BDUSSæ”¾åœ¨è¿™
```

### æ­¥éª¤3

å†æ¬¡è¿è¡Œ`debug.py`ï¼Œå¦‚æœä½ çš„`BDUSS`å¡«å†™æ— è¯¯ï¼Œä½ å°±èƒ½å¾—åˆ°ç±»ä¼¼è¿™æ ·çš„ç”¨æˆ·ä¸ªäººä¿¡æ¯

```log
<2022-06-24 22:53:00> [INFO] å½“å‰ç”¨æˆ·ä¿¡æ¯: BasicUserInfo [user_id:957339815 / user_name:kkä¸å¥½ç© / portrait:tb.1.8277e641.gUE2cTq4A4z5fi2EHn5k3Q / nick_name:]
```

## æ¡ˆä¾‹2 ç®€å•å¹¶å‘çˆ¬è™«

å°†ä¸‹åˆ—ä»£ç å¤åˆ¶åˆ°`debug.py`å¹¶è¿è¡Œ

```python
import asyncio

import aiotieba as tb


async def main():
    # ä½¿ç”¨é”®å"default"å¯¹åº”çš„BDUSSåˆ›å»ºå®¢æˆ·ç«¯
    async with tb.Client("default") as client:
        # ä¸‹é¢è¿™è¡Œè¯­å¥ä¼šåŒæ—¶è¯·æ±‚ç”¨æˆ·ä¸ªäººä¿¡æ¯å’Œå›¾æ‹‰ä¸å§é¦–é¡µå‰30å¸–
        # ä½ å¯ä»¥å°†è‹¥å¹²åç¨‹ä½œä¸ºå‚æ•°ä¼ å…¥asyncio.gatherï¼Œè¿™é‡Œä¼ å…¥çš„å‚æ•°client.get_self_info()å’Œclient.get_threads('å›¾æ‹‰ä¸')
        # asyncio.gatherä¼šä¸ºæ¯ä¸ªä¼ å…¥çš„åç¨‹åˆ›å»ºå¯¹åº”çš„ä»»åŠ¡æ¥åŒæ—¶æ‰§è¡Œå®ƒä»¬ï¼ˆå¹¶å‘ï¼‰
        # åŒæ—¶asyncio.gather(...)ä¹Ÿä¼šè¿”å›ä¸€ä¸ªåç¨‹ï¼Œåœ¨å‰é¢æ·»åŠ awaitç­‰å¾…å…¶æ‰§è¡Œå®Œæ¯•
        # æ‰§è¡Œå®Œæ¯•åï¼Œè¿”å›æ•°æ®çš„é¡ºåºä¸ä¼ å…¥å‚æ•°çš„é¡ºåºä¸€è‡´ï¼Œå³userå¯¹åº”client.get_self_info()ï¼Œthreadså¯¹åº”client.get_threads('å›¾æ‹‰ä¸')
        # å‚è€ƒå®˜æ–¹æ–‡æ¡£ï¼šå¹¶å‘è¿è¡Œä»»åŠ¡
        # https://docs.python.org/zh-cn/3/library/asyncio-task.html#running-tasks-concurrently
        user, threads = await asyncio.gather(client.get_self_info(), client.get_threads('å›¾æ‹‰ä¸'))

    # å°†è·å–çš„ä¿¡æ¯æ‰“å°åˆ°æ—¥å¿—
    tb.LOG.info(f"å½“å‰ç”¨æˆ·ä¿¡æ¯: {user}")
    for thread in threads:
        # threadsæ”¯æŒè¿­ä»£ï¼Œå› æ­¤å¯ä»¥ä½¿ç”¨forå¾ªç¯é€æ¡æ‰“å°ä¸»é¢˜å¸–ä¿¡æ¯
        tb.LOG.info(f"tid: {thread.tid} æœ€åå›å¤æ—¶é—´æˆ³: {thread.last_time} æ ‡é¢˜: {thread.title}")


# ä½¿ç”¨asyncio.runæ‰§è¡Œåç¨‹main
asyncio.run(main())
```

è¿è¡Œæ•ˆæœå¦‚ä¸‹æ‰€ç¤º

```log
<2022-06-24 23:42:21> [INFO] å½“å‰ç”¨æˆ·ä¿¡æ¯: BasicUserInfo [user_id:957339815 / user_name:kkä¸å¥½ç© / portrait:tb.1.8277e641.gUE2cTq4A4z5fi2EHn5k3Q / nick_name:]
<2022-06-24 23:42:21> [INFO] tid: 2949701560 æœ€åå›å¤æ—¶é—´æˆ³: 1655803255 æ ‡é¢˜: ã€é‡è¦æ›´æ–°ã€‘ç™¾åº¦å›¾æ‹‰ä¸å§å§è§„ 20140329 
<2022-06-24 23:42:21> [INFO] tid: 7892695736 æœ€åå›å¤æ—¶é—´æˆ³: 1656085315 æ ‡é¢˜: è‹±ç‰¹å°”ä¸€æ—¥æ¸¸ï¼ï¼ï¼ï¼
<2022-06-24 23:42:21> [INFO] tid: 7893369941 æœ€åå›å¤æ—¶é—´æˆ³: 1656085331 æ ‡é¢˜: å°ç™½å·²ä¸‹å•ï¼Œ8uä»¬æ¨èä¸ªç¡…è„‚
<2022-06-24 23:42:21> [INFO] tid: 7889615680 æœ€åå›å¤æ—¶é—´æˆ³: 1656085325 æ ‡é¢˜: å›¾çˆ·çˆ·ä»¬1080ti 11gå’Œ2060s 8gé€‰å“ªä¸ªğŸ¦†  
<2022-06-24 23:42:21> [INFO] tid: 7893286940 æœ€åå›å¤æ—¶é—´æˆ³: 1656085323 æ ‡é¢˜: 
<2022-06-24 23:42:21> [INFO] tid: 7892384466 æœ€åå›å¤æ—¶é—´æˆ³: 1656085322 æ ‡é¢˜: æœ¬åœ°ç†Ÿäººé‚£æ”¶äº†ä¸€ä¸ªè‡ªç”¨éçŸ¿çš„3070ç«ç¥OC
<2022-06-24 23:42:21> [INFO] tid: 7893402353 æœ€åå›å¤æ—¶é—´æˆ³: 1656085320 æ ‡é¢˜: ğŸ”¥
<2022-06-24 23:42:21> [INFO] tid: 7891883553 æœ€åå›å¤æ—¶é—´æˆ³: 1656085320 æ ‡é¢˜: è€å“¥ä»¬ï¼Œæœºå­ç‚¹ä¸äº®æ˜¯ä»€ä¹ˆåŸå› ï¼Ÿ
<2022-06-24 23:42:21> [INFO] tid: 7893181859 æœ€åå›å¤æ—¶é—´æˆ³: 1656085318 æ ‡é¢˜: æˆ‘åº”è¯¥æŠŠç”µæºæ”¾åœ¨å“ªé‡Œï¼Ÿ
<2022-06-24 23:42:21> [INFO] tid: 7892767446 æœ€åå›å¤æ—¶é—´æˆ³: 1656085318 æ ‡é¢˜: æ¼ç”µæ€ä¹ˆæï¼Ÿ
<2022-06-24 23:42:21> [INFO] tid: 7892847573 æœ€åå›å¤æ—¶é—´æˆ³: 1656085316 æ ‡é¢˜: æœ‰æ²¡æœ‰ä¸é‡è£…ç³»ç»Ÿèƒ½æŠŠ360å®‰å…¨å«å£«å¸æ‰çš„åŠæ³•ï¼Ÿ
<2022-06-24 23:42:21> [INFO] tid: 7893393344 æœ€åå›å¤æ—¶é—´æˆ³: 1656085313 æ ‡é¢˜: é›·ç¥é»‘æ­¦å£«æ˜¾ç¤ºå±å’‹æ ·å•Šï¼Œæœ‰å§å‹ä¹°å—
<2022-06-24 23:42:21> [INFO] tid: 7893393714 æœ€åå›å¤æ—¶é—´æˆ³: 1656085310 æ ‡é¢˜: å¼€æœºå±å¹•å·¦ä¸Šè§’ä¸€ç›´é—ªè¿›ä¸äº†ç³»ç»Ÿå’‹å›äº‹å‘€
<2022-06-24 23:42:21> [INFO] tid: 7890774730 æœ€åå›å¤æ—¶é—´æˆ³: 1656085311 æ ‡é¢˜: å’Œå®¶é‡Œäººåµäº†ä¸€æ¶ç”µè„‘è¢«æ‘”äº†
<2022-06-24 23:42:21> [INFO] tid: 7893140352 æœ€åå›å¤æ—¶é—´æˆ³: 1656085311 æ ‡é¢˜: ç›´æ’­å¼€ä¿©å±è‚¡
<2022-06-24 23:42:21> [INFO] tid: 7892668486 æœ€åå›å¤æ—¶é—´æˆ³: 1656057522 æ ‡é¢˜: ç‰›çˆ·çˆ·ä»¬ï¼Œæ½œä¼ä¸¤å¹´ï¼Œçœ‹ä¸Šä¸€å¥—é…ç½®
<2022-06-24 23:42:21> [INFO] tid: 7893401658 æœ€åå›å¤æ—¶é—´æˆ³: 1656085287 æ ‡é¢˜: ä¸æƒ³è‡ªå·±é…ï¼Œ7499ä¹°è¿™å¥—æ•´æœºï¼Œä¼šä¸ä¼šæˆæ€¨ç§ï¼Ÿ
<2022-06-24 23:42:21> [INFO] tid: 7892318957 æœ€åå›å¤æ—¶é—´æˆ³: 1656085285 æ ‡é¢˜: ç¬”è®°æœ¬å’Œå°å¼çš„é€‰æ‹©
<2022-06-24 23:42:21> [INFO] tid: 7892682911 æœ€åå›å¤æ—¶é—´æˆ³: 1656085283 æ ‡é¢˜: å–ä¸€å¥—ç”µè„‘æµå®è‡ªæ
<2022-06-24 23:42:21> [INFO] tid: 7891682107 æœ€åå›å¤æ—¶é—´æˆ³: 1656085279 æ ‡é¢˜: åœ¨å°é»„é±¼ä¹°çš„åäººå ‚970é—®ä¸€ä¸‹å„ä½å¤§ä½¬æœ‰æ²¡æœ‰åŠæ³•ç¿»æ–°ä¸€ä¸‹ï¼Ÿ
<2022-06-24 23:42:21> [INFO] tid: 7893393301 æœ€åå›å¤æ—¶é—´æˆ³: 1656085279 æ ‡é¢˜: ç¬‘æ­»æˆ‘äº†ï¼Œç¿æ™ºéª—å­
<2022-06-24 23:42:21> [INFO] tid: 7893394823 æœ€åå›å¤æ—¶é—´æˆ³: 1656085278 æ ‡é¢˜: å¤§ä½¬ä»¬ï¼Œè¿™ä¸ªå€¼ä¸å€¼5100
<2022-06-24 23:42:21> [INFO] tid: 7893396379 æœ€åå›å¤æ—¶é—´æˆ³: 1656085272 æ ‡é¢˜: 4000å…ƒç»„è£…ç”µè„‘
<2022-06-24 23:42:21> [INFO] tid: 7892789785 æœ€åå›å¤æ—¶é—´æˆ³: 1656085271 æ ‡é¢˜: æ€ä¹ˆè¯„ä»·xdm
<2022-06-24 23:42:21> [INFO] tid: 7893403186 æœ€åå›å¤æ—¶é—´æˆ³: 1656085269 æ ‡é¢˜: å…³äºrgbé—®é¢˜
<2022-06-24 23:42:21> [INFO] tid: 7882628878 æœ€åå›å¤æ—¶é—´æˆ³: 1656085266 æ ‡é¢˜: ä¹°çš„3200å†…å­˜æ¡å‘æˆ3600äº†ï¼Œèƒ½ç”¨å—ï¼Ÿ
<2022-06-24 23:42:21> [INFO] tid: 7892332764 æœ€åå›å¤æ—¶é—´æˆ³: 1656085261 æ ‡é¢˜: å°ç™½æƒ³è¦ä¸ªæ— å…‰æ•£çƒ­å™¨ï¼Œè¿™ä¹ˆéš¾å—sos
<2022-06-24 23:42:21> [INFO] tid: 7893398448 æœ€åå›å¤æ—¶é—´æˆ³: 1656085258 æ ‡é¢˜: ç°åœ¨å‡º2060 6gäºŒæ‰‹çš„å¤§æ¦‚å•¥ä»·ä½å•Šï¼Ÿ
<2022-06-24 23:42:21> [INFO] tid: 7893289924 æœ€åå›å¤æ—¶é—´æˆ³: 1656085257 æ ‡é¢˜: è£…æœºå¤±è´¥äº†
<2022-06-24 23:42:21> [INFO] tid: 7892430358 æœ€åå›å¤æ—¶é—´æˆ³: 1656085249 æ ‡é¢˜: å…„å¼Ÿä»¬é€Ÿæ¥
```

## æ¡ˆä¾‹3 å¤šåç¨‹çˆ¬è™«

å°†ä¸‹åˆ—ä»£ç å¤åˆ¶åˆ°`debug.py`å¹¶è¿è¡Œ

```python
import asyncio
import time
from typing import List

import aiotieba as tb


async def crawler(fname: str):
    """
    è·å–è´´å§åä¸ºfnameçš„è´´å§çš„å‰32é¡µä¸­æµè§ˆé‡æœ€é«˜çš„10ä¸ªä¸»é¢˜å¸–

    Args:
        fname (str): è´´å§å
    """

    start_time = time.perf_counter()
    tb.LOG.info("Spider start")

    # thread_listç”¨æ¥ä¿å­˜ä¸»é¢˜å¸–åˆ—è¡¨
    thread_list: List[tb.Thread] = []

    # ä½¿ç”¨é”®å"default"å¯¹åº”çš„BDUSSåˆ›å»ºå®¢æˆ·ç«¯
    async with tb.Client("default") as brow:

        # asyncio.Queueæ˜¯ä¸€ä¸ªä»»åŠ¡é˜Ÿåˆ—
        # maxsize=8æ„å‘³ç€ç¼“å†²åŒºé•¿åº¦ä¸º8
        # å½“ç¼“å†²åŒºè¢«å¡«æ»¡æ—¶ï¼Œè°ƒç”¨Queue.putçš„åç¨‹ä¼šè¢«é˜»å¡
        task_queue = asyncio.Queue(maxsize=8)
        # å½“is_runningè¢«è®¾ä¸ºFalseåï¼Œæ¶ˆè´¹è€…ä¼šåœ¨è¶…æ—¶åé€€å‡º
        is_running = True

        async def producer():
            """
            ç”Ÿäº§è€…åç¨‹
            """

            for pn in range(32, 0, -1):
                # ç”Ÿäº§è€…ä½¿ç”¨Queue.putä¸æ–­åœ°å°†é¡µç pnå¡«å…¥ä»»åŠ¡é˜Ÿåˆ—task_queue
                await task_queue.put(pn)
            # è¿™é‡Œéœ€è¦nonlocalæ¥å…è®¸å¯¹é—­åŒ…å¤–çš„å˜é‡çš„ä¿®æ”¹æ“ä½œï¼ˆç±»ä¼¼äºå¼•ç”¨ä¼ é€’å’Œå€¼ä¼ é€’çš„åŒºåˆ«ï¼‰
            nonlocal is_running
            is_running = False

        async def worker(i: int):
            """
            æ¶ˆè´¹è€…åç¨‹

            Args:
                i (int): åç¨‹ç¼–å·
            """

            while 1:
                try:
                    # æ¶ˆè´¹è€…åç¨‹ä¸æ–­åœ°ä½¿ç”¨Queue.getä»task_queueä¸­æ‹‰å–ç”±ç”Ÿäº§è€…åç¨‹æä¾›çš„é¡µç pnä½œä¸ºä»»åŠ¡
                    # asyncio.wait_forç”¨äºç­‰å¾…ä¸€ä¸ªåç¨‹æ‰§è¡Œå®Œæ¯•ç›´åˆ°è¶…æ—¶
                    # timeout=1å³æŠŠè¶…æ—¶æ—¶é—´è®¾ä¸º1ç§’
                    # å¦‚æœè¶…è¿‡1ç§’æœªè·å–åˆ°æ–°çš„é¡µç pnï¼Œasyncio.wait_forå°†æŠ›å‡ºasyncio.TimeoutError
                    pn = await asyncio.wait_for(task_queue.get(), timeout=1)
                    tb.LOG.debug(f"Worker#{i} handling pn:{pn}")
                except asyncio.TimeoutError:
                    # æ•è·asyncio.TimeoutErrorä»¥é€€å‡ºåç¨‹
                    if is_running is False:
                        # å¦‚æœis_runningä¸ºFalseï¼Œæ„å‘³ç€ä¸éœ€è¦å†è½®è¯¢task_queueè·å–æ–°ä»»åŠ¡
                        tb.LOG.debug(f"Worker#{i} quit")
                        # æ¶ˆè´¹è€…åç¨‹é€šè¿‡returné€€å‡º
                        return
                else:
                    # æ‰§è¡Œè¢«åˆ†æ´¾çš„ä»»åŠ¡ï¼Œå³çˆ¬å–pné¡µçš„å¸–å­åˆ—è¡¨
                    threads = await brow.get_threads(fname, pn)
                    # è¿™é‡Œçš„nonlocalåŒæ ·æ˜¯ä¸ºäº†ä¿®æ”¹é—­åŒ…å¤–çš„å˜é‡thread_list
                    nonlocal thread_list
                    thread_list += threads

        # åˆ›å»º8ä¸ªæ¶ˆè´¹è€…åç¨‹
        workers = [worker(i) for i in range(8)]
        # ä½¿ç”¨asyncio.gatherå¹¶å‘æ‰§è¡Œ
        # éœ€è¦æ³¨æ„è¿™é‡Œ*workersä¸­çš„*æ„ä¸ºå°†åˆ—è¡¨å±•å¼€æˆå¤šä¸ªå‚æ•°
        # å› ä¸ºasyncio.gatheråªæ¥å—åç¨‹ä½œä¸ºå‚æ•°ï¼Œä¸æ¥å—åç¨‹åˆ—è¡¨
        await asyncio.gather(*workers, producer())

    tb.LOG.info(f"Spider complete. Time cost:{time.perf_counter()-start_time:.4f} s")

    # æŒ‰ä¸»é¢˜å¸–æµè§ˆé‡é™åºæ’åº
    thread_list.sort(key=lambda thread: thread.view_num, reverse=True)
    # å°†æµè§ˆé‡æœ€é«˜çš„10ä¸ªä¸»é¢˜å¸–çš„ä¿¡æ¯æ‰“å°åˆ°æ—¥å¿—
    for i, thread in enumerate(thread_list[0:10], 1):
        tb.LOG.info(f"Rank#{i} view_num:{thread.view_num} title:{thread.title}")


# æ‰§è¡Œåç¨‹crawler
asyncio.run(crawler("å›¾æ‹‰ä¸"))
```

è¿è¡Œæ•ˆæœå¦‚ä¸‹å›¾æ‰€ç¤º

```log
<2022-06-25 00:06:54> [INFO] Spider start
<2022-06-25 00:06:54> [DEBUG] Worker#0 handling pn:32
<2022-06-25 00:06:54> [DEBUG] Worker#1 handling pn:31
<2022-06-25 00:06:54> [DEBUG] Worker#2 handling pn:30
<2022-06-25 00:06:54> [DEBUG] Worker#3 handling pn:29
<2022-06-25 00:06:54> [DEBUG] Worker#4 handling pn:28
<2022-06-25 00:06:54> [DEBUG] Worker#5 handling pn:27
<2022-06-25 00:06:54> [DEBUG] Worker#6 handling pn:26
<2022-06-25 00:06:54> [DEBUG] Worker#7 handling pn:25
<2022-06-25 00:06:54> [DEBUG] Worker#0 handling pn:24
<2022-06-25 00:06:54> [DEBUG] Worker#1 handling pn:23
<2022-06-25 00:06:54> [DEBUG] Worker#4 handling pn:22
<2022-06-25 00:06:54> [DEBUG] Worker#7 handling pn:21
<2022-06-25 00:06:54> [DEBUG] Worker#6 handling pn:20
<2022-06-25 00:06:54> [DEBUG] Worker#2 handling pn:19
<2022-06-25 00:06:54> [DEBUG] Worker#5 handling pn:18
<2022-06-25 00:06:54> [DEBUG] Worker#3 handling pn:17
<2022-06-25 00:06:55> [DEBUG] Worker#1 handling pn:16
<2022-06-25 00:06:55> [DEBUG] Worker#4 handling pn:15
<2022-06-25 00:06:55> [DEBUG] Worker#0 handling pn:14
<2022-06-25 00:06:55> [DEBUG] Worker#7 handling pn:13
<2022-06-25 00:06:55> [DEBUG] Worker#6 handling pn:12
<2022-06-25 00:06:55> [DEBUG] Worker#2 handling pn:11
<2022-06-25 00:06:55> [DEBUG] Worker#3 handling pn:10
<2022-06-25 00:06:55> [DEBUG] Worker#5 handling pn:9
<2022-06-25 00:06:55> [DEBUG] Worker#1 handling pn:8
<2022-06-25 00:06:55> [DEBUG] Worker#6 handling pn:7
<2022-06-25 00:06:55> [DEBUG] Worker#0 handling pn:6
<2022-06-25 00:06:55> [DEBUG] Worker#4 handling pn:5
<2022-06-25 00:06:55> [DEBUG] Worker#7 handling pn:4
<2022-06-25 00:06:55> [DEBUG] Worker#2 handling pn:3
<2022-06-25 00:06:55> [DEBUG] Worker#5 handling pn:2
<2022-06-25 00:06:55> [DEBUG] Worker#3 handling pn:1
<2022-06-25 00:06:57> [DEBUG] Worker#1 quit
<2022-06-25 00:06:57> [DEBUG] Worker#6 quit
<2022-06-25 00:06:57> [DEBUG] Worker#7 quit
<2022-06-25 00:06:57> [DEBUG] Worker#0 quit
<2022-06-25 00:06:57> [DEBUG] Worker#2 quit
<2022-06-25 00:06:57> [DEBUG] Worker#5 quit
<2022-06-25 00:06:57> [DEBUG] Worker#3 quit
<2022-06-25 00:06:57> [DEBUG] Worker#4 quit
<2022-06-25 00:06:57> [INFO] Spider complete. Time cost:3.4798 s
<2022-06-25 00:06:57> [INFO] Rank#1 view_num:1682535 title:ã€åœ¾ä½¬ä¹å›­ã€‘å›¾å§åƒåœ¾é›†æ•£åœ°(2020ç§‹å­£)
<2022-06-25 00:06:57> [INFO] Rank#2 view_num:1660786 title:ã€é‡è¦æ›´æ–°ã€‘ç™¾åº¦å›¾æ‹‰ä¸å§å§è§„ 20140329
<2022-06-25 00:06:57> [INFO] Rank#3 view_num:516367 title:ä¸‹æ¥¼å€’åƒåœ¾ï¼ŒçŒ«æ‹‰äº†å±ä¸æ‰”å¤ªè‡­äº†ï¼Œç¢°åˆ°ä¸€ä¸ªè€é˜¿å§¨æ¬ä¸ªç”µè„‘
<2022-06-25 00:06:57> [INFO] Rank#4 view_num:330913 title:ã€åœ¾ä½¬ä¹å›­ã€‘å›¾å§åƒåœ¾å›æ”¶ç«™(2021å¹´å†¬å­£)
<2022-06-25 00:06:57> [INFO] Rank#5 view_num:272151 title:ç¬¬ä¸€æ¬¡æ¡æ¼æˆåŠŸï¼Œæ‹¿ç€å¡æˆ‘å°±è·‘äº†
<2022-06-25 00:06:57> [INFO] Rank#6 view_num:156774 title:å…³äºæ˜¨å¤©1Kæ¡çš„è¶…çº§å¤§æ¼ï¼Œï¼Œåç»­
<2022-06-25 00:06:57> [INFO] Rank#7 view_num:154691 title:å…³äºæ™ºå•†æ£€æµ‹å¡
<2022-06-25 00:06:57> [INFO] Rank#8 view_num:135642 title:çŸ¿å¡ä¸€æ—¶çˆ½ï¼Œä¸€ç›´çŸ¿å¡ä¸€ç›´çˆ½
<2022-06-25 00:06:57> [INFO] Rank#9 view_num:112119 title:è¿™å±Šå°ç™½çœŸéš¾ä¼ºå€™
<2022-06-25 00:06:57> [INFO] Rank#10 view_num:105320 title:618æ”’äº†ä¸€å°æœºï¼Œè€—äº†æˆ‘ä¸€å¹´ç§¯è“„
```

## ç»“è¯­

ä½¿ç”¨å¼‚æ­¥è¯·æ±‚ç›¸å½“äºç”¨æ›´é«˜çš„è°ƒåº¦æˆæœ¬æ¢å–æ›´ä½çš„æ—¶é—´æˆæœ¬ï¼Œå…¶æ ¸å¿ƒä»·å€¼å°±åœ¨äºå‡å°‘åŒæ­¥IOå¯¹çˆ¬è™«æ•ˆç‡çš„é™åˆ¶

æƒ³è¿›ä¸€æ­¥äº†è§£`aiotieba`åœ¨äº‘å®¡æŸ¥ä¸Šçš„åº”ç”¨ï¼Œè¯·é˜…è¯»[äº‘å®¡æŸ¥å·¥å…·ä»‹ç»](cloud_review_introduction.md)
